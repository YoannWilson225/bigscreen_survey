<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de Sondage</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <style>
      /* Styles spécifiques à la navbar */
      .navbar {
          background-color: #333;
      }

      .navbar-brand {
          color: #fff;
      }

      .navbar-nav .nav-link {
          color: #fff;
      }
  </style>
</head>

<body>


  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">
        <svg >
            <defs>
                <style>.cls-1{fill:#fff;}</style>
            </defs>
            <title>bigscreen</title>
            <rect class="cls-1" x="48" y="8" width="8" height="40"/>
            <path class="cls-1" d="M8,8V0H0V48H40V8H8ZM32,40H8V16H32Z"/>
            <path class="cls-1" d="M72,8H64V40H96v8H72v8h32V8H72ZM96,32H72V16H96Z"/>
            <polygon class="cls-1" points="119 8 112 8 112 32 113 32 120 32 144 32 144 40 112 40 112 48 144 48 152 48 152 40 152 32 152 24 144 24 120 24 120 16 152 16 152 8 120 8 119 8"/>
            <polygon class="cls-1" points="160 8 160 16 160 48 163 48 168 48 200 48 200 40 168 40 168 16 200 16 200 8 168 8 160 8"/>
            <polygon class="cls-1" points="212 8 208 8 208 48 216 48 216 16 248 16 248 8 216 8 212 8"/>
            <path class="cls-1" d="M264,8h-8V48h40V40H264V32h32V8H264Zm25,16H264V16h25Z"/>
            <path class="cls-1" d="M312,8h-8V48h40V40H312V32h32V8H312Zm24,16H312V16h24Z"/>
            <polygon class="cls-1" points="384 8 360 8 352 8 352 16 352 48 360 48 360 16 384 16 384 48 392 48 392 16 392 8 384 8"/>
        </svg>
    </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</nav>

    <div class="container mt-5">
      <div class="alert alert-primary" role="alert">
       Merci de répondre à toutes les questions et de valider le formulaire <br>en bas de page
      </div>
        <form id="surveyForm">
            <div id="questionsContainer"></div>
            <button type="submit" class="btn btn-primary">Soumettre</button>
        </form>
    </div>

    <script>
        // Déclarer la variable questions dans le scope global
        let questions;

        // Créer une instance de XMLHttpRequest
        const xhr = new XMLHttpRequest();

        // Envoyer la requête GET vers l'API
        xhr.open('GET', 'http://localhost:8000/api/questions', true);
        xhr.send();

        // Définir la fonction de rappel pour la réponse
        xhr.onload = function() {
            if (xhr.status !== 200) {
                console.error(`Erreur ${xhr.status} : ${xhr.statusText}`);
                return;
            }

            let response;
            try {
                response = JSON.parse(xhr.responseText);
            } catch (error) {
                console.error('Erreur lors du parsing de la réponse JSON :', error);
                return;
            }

            questions = response.questions;

            if (!Array.isArray(questions)) {
                console.error("Les questions ne sont pas valides.");
                return;
            }

            const questionsContainer = document.getElementById('questionsContainer');

            if (questions.length === 0) {
                const noQuestionsMessage = document.createElement('p');
                noQuestionsMessage.textContent = "Aucune question n'est disponible.";
                questionsContainer.appendChild(noQuestionsMessage);
            } else {
                questions.forEach((question, index) => {
                    const questionId = question.id;
                    const questionIndex = index + 1; // Ajoutez 1 au compteur d'index
                    let questionHTML = `
                        <div class="form-group">
                          <label for="question_${questionIndex}">
                    <span style="font-weight: bold; font-size: 16px;">Question ${questionIndex}/20</span><br>
                    <span>${question.body}</span>
                </label>`;

                    if (question.type === 'A') {
                        questionHTML += `
                            <select class="form-control" id="question_${questionIndex}" name="question_${questionIndex}" required>
                                <option value="">Sélectionnez une option</option>`;

                        question.options.forEach((option) => {
                            questionHTML += `<option value="${option}">${option}</option>`;
                        });

                        questionHTML += `</select>`;

                    } else if (question.type === 'B') {
                        questionHTML += `
                            <input type="text" class="form-control" id="question_${questionIndex}" name="question_${questionIndex}" maxlength="255" required>`;
                    } else if (question.type === 'C') {
                        questionHTML += `
                            <input type="number" class="form-control" id="question_${questionIndex}" name="question_${questionIndex}" min="1" max="5" required>`;
                    }

                    questionHTML += `</div>`;
                    questionsContainer.innerHTML += questionHTML;
                });
            }
        };

        // Récupérer le formulaire
        const surveyForm = document.getElementById('surveyForm');

        // Ajouter un écouteur d'événement sur la soumission du formulaire
        surveyForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Empêcher le comportement par défaut du formulaire

            // Récupérer les réponses du formulaire
            const answers = [];

            for (let index = 0; index < questions.length; index++) {
                const question = questions[index];
                const questionId = question.id; // Utilisez l'ID de la question
                const questionIndex = index + 1;
                const input = document.getElementById(`question_${questionIndex}`);
                const answer = {
                    question_id: questionId,
                    value: input.value
                };
                answers.push(answer);
            }

            // Créer une instance de XMLHttpRequest
            const xhr = new XMLHttpRequest();

            // Envoyer la requête POST vers l'API pour enregistrer les réponses
            xhr.open('POST', 'http://localhost:8000/api/answers', true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onload = function() {
                if (xhr.status === 200) {
                    // Réponses enregistrées avec succès
                    alert('Réponses enregistrées avec succès');
                      location.reload(); // Rediriger vers la page de confirmation
                } else {
                    // Erreur lors de l'enregistrement des réponses
                    console.error('Erreur lors de l\'enregistrement des réponses');
                }
            };

            xhr.send(JSON.stringify({ answers }));
        });

    </script>

</body>

</html>
